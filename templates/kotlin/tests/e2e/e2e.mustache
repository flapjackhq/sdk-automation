// {{generationBanner}}
package com.flapjackhq.e2e

import com.flapjackhq.client.api.{{client}}
import com.flapjackhq.client.model.{{import}}.*
import com.flapjackhq.client.configuration.*
import com.flapjackhq.client.transport.*
import com.flapjackhq.utils.*
import org.skyscreamer.jsonassert.JSONAssert;
import org.skyscreamer.jsonassert.JSONCompareMode;
import io.ktor.http.*
import io.github.cdimascio.dotenv.Dotenv
import kotlinx.coroutines.test.*
import kotlinx.serialization.json.*
import kotlinx.serialization.encodeToString
import kotlin.test.*
import kotlin.time.Duration.Companion.milliseconds

{{#isCompositionClient}}
import com.flapjackhq.client.model.{{import}}.RequestBody
{{/isCompositionClient}}

class {{clientPrefix}}Test {

    var client: {{client}};

    init {
      if (System.getenv("CI") == "true") {
        this.client = {{client}}(appId = System.getenv("{{e2eAppID}}"), apiKey = System.getenv("{{e2eApiKey}}"){{#hasRegionalHost}}, region = "{{defaultRegion}}", {{/hasRegionalHost}});
      } else {
        val dotenv = Dotenv.configure().directory("../../").load()
        this.client = {{client}}(appId = dotenv["{{e2eAppID}}"], apiKey = dotenv["{{e2eApiKey}}"]{{#hasRegionalHost}}, region = "{{defaultRegion}}", {{/hasRegionalHost}});
      }
    }

    {{#blocksE2E}}
    {{#tests}}
    @Test
    fun `{{#lambda.replaceBacktick}}{{{testName}}}{{testIndex}}{{/lambda.replaceBacktick}}`() = runTest {
        client.runTest(
            call = {
                {{> tests/method}}
            },
            {{#response}}
            {{#body}}
            response = {
              JSONAssert.assertEquals("{{#lambda.escapeQuotes}}{{{body}}}{{/lambda.escapeQuotes}}", Json.encodeToString(it), JSONCompareMode.LENIENT)
            },
            {{/body}}
            {{/response}}
        )
    }

    {{/tests}}
    {{/blocksE2E}}
}